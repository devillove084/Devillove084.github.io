<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>RDMA-Toy-1 PingPong和概念梳理 - Database builder</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Database builder"><meta name="msapplication-TileImage" content="/images/ironman.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Database builder"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="概念对齐verbs 是 RDMA 的底层编程接口，目的是通过一组 ibv_* 调用把用户读写任务（WR）提交到队列（QP），网卡按这些请求在不经过内核协议栈的前提下执行 SEND&amp;#x2F;RECV、RDMA READ&amp;#x2F;WRITE、原子操作 等动作，并把结果以完成事件（CQE）的形式回报给应用。 ▸ 类比：BSD sockets 是用 TCP&amp;#x2F;UDP 传字节的系统调用集合，ve"><meta property="og:type" content="blog"><meta property="og:title" content="RDMA-Toy-1 PingPong和概念梳理"><meta property="og:url" content="https://devillove084.github.io/2025/09/20/RDMA-2/"><meta property="og:site_name" content="Database builder"><meta property="og:description" content="概念对齐verbs 是 RDMA 的底层编程接口，目的是通过一组 ibv_* 调用把用户读写任务（WR）提交到队列（QP），网卡按这些请求在不经过内核协议栈的前提下执行 SEND&amp;#x2F;RECV、RDMA READ&amp;#x2F;WRITE、原子操作 等动作，并把结果以完成事件（CQE）的形式回报给应用。 ▸ 类比：BSD sockets 是用 TCP&amp;#x2F;UDP 传字节的系统调用集合，ve"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://devillove084.github.io/img/og_image.png"><meta property="article:published_time" content="2025-09-20T14:56:57.000Z"><meta property="article:modified_time" content="2025-09-21T03:59:41.771Z"><meta property="article:author" content="devillove084"><meta property="article:tag" content="rdma"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://devillove084.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://devillove084.github.io/2025/09/20/RDMA-2/"},"headline":"RDMA-Toy-1 PingPong和概念梳理","image":["https://devillove084.github.io/img/og_image.png"],"datePublished":"2025-09-20T14:56:57.000Z","dateModified":"2025-09-21T03:59:41.771Z","author":{"@type":"Person","name":"devillove084"},"publisher":{"@type":"Organization","name":"Database builder","logo":{"@type":"ImageObject","url":"https://devillove084.github.io/images/ironman.svg"}},"description":"概念对齐verbs 是 RDMA 的底层编程接口，目的是通过一组 ibv_* 调用把用户读写任务（WR）提交到队列（QP），网卡按这些请求在不经过内核协议栈的前提下执行 SEND&#x2F;RECV、RDMA READ&#x2F;WRITE、原子操作 等动作，并把结果以完成事件（CQE）的形式回报给应用。 ▸ 类比：BSD sockets 是用 TCP&#x2F;UDP 传字节的系统调用集合，ve"}</script><link rel="canonical" href="https://devillove084.github.io/2025/09/20/RDMA-2/"><link rel="icon" href="/images/ironman.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link data-pjax rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/ironman.svg" alt="Database builder" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Intro in github" href="https://github.com/devillove084"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2025-09-20T14:56:57.000Z" title="9/20/2025, 2:56:57 PM">2025-09-20</time>发表</span><span class="level-item"><time dateTime="2025-09-21T03:59:41.771Z" title="9/21/2025, 3:59:41 AM">2025-09-21</time>更新</span><span class="level-item">27 分钟读完 (大约4099个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">RDMA-Toy-1 PingPong和概念梳理</h1><div class="content"><h2 id="概念对齐"><a href="#概念对齐" class="headerlink" title="概念对齐"></a>概念对齐</h2><p>verbs 是 RDMA 的底层编程接口，目的是通过一组 ibv_* 调用把用户读写任务（WR）提交到队列（QP），网卡按这些请求在不经过内核协议栈的前提下执行 SEND&#x2F;RECV、RDMA READ&#x2F;WRITE、原子操作 等动作，并把结果以完成事件（CQE）的形式回报给应用。</p>
<p>▸ 类比：BSD sockets 是用 TCP&#x2F;UDP 传字节的系统调用集合，verbs 是用 RDMA 传内存的系统调用集合。sockets 交给内核协议栈；verbs 交给 RNIC 的硬件队列。</p>
<p>InfiniBand verbs 规范定义 HCA 能执行的动作（post、poll、create、modify等），因此在 Linux 用户态库中呈现为一组 ibv_* API。而不同厂商通过 provider（如 libmlx5、librxe）实现背后的具体硬件&#x2F;软件行为，但对应用暴露统一的 verbs 抽象。</p>
<ul>
<li>用户态库：libibverbs（rdma-core）+ 各 provider（libmlx5, librxe）。</li>
<li>字符设备：&#x2F;dev&#x2F;infiniband&#x2F;uverbsX、rdma_cm 等承接与内核的 ioctl&#x2F;事件通道。</li>
</ul>
<blockquote>
<p>这也是为什么混装发行版包与第三方 OFED 会报错“符号找不到”，因为应用链接的 lib 库与内核驱动&#x2F;provider <strong>实现必须匹配</strong>。</p>
</blockquote>
<span id="more"></span>

<p>关键对象：</p>
<ul>
<li>Device &#x2F; Context：网卡设备与用户态句柄（ibv_open_device）；</li>
<li>PD（Protection Domain）：保护域，用于把 QP、MR、CQ 等资源组合；</li>
<li>MR（Memory Region）：注册内存，获得 lkey&#x2F;rkey 以供 DMA 访问（ibv_reg_mr）；</li>
<li>CQ（Completion Queue）：完成队列，硬件把执行结果写成 CQE，使用 ibv_poll_cq 取出；</li>
<li>QP（Queue Pair）：一对发送队列 SQ 与接收队列 RQ。是一个可靠连接 RC 的典型状态机：RESET→INIT→RTR→RTS；</li>
<li>WR（Work Request）：用户指令，如 post a SEND 或 do RDMA WRITE；</li>
<li>SGE（Scatter&#x2F;Gather Entry）：描述这条 WR 要访问的内存片段（地址、长度、lkey）。</li>
<li>WQE：WR 进入硬件队列后的条目形式；</li>
<li>WC（Work Completion）：CQ 里读到的一条完成记录（含 status、wr_id 等）。</li>
<li>HCA（Host Channel Adapter）：主机侧的 RDMA 适配器，硬件或软件实现，提供 QP&#x2F;CQ&#x2F;MR 等verbs能力，并执行 DMA。</li>
<li>lkey（local key）：本机访问某块注册内存（MR）时必须携带的访问令牌；</li>
<li>rkey（remote key）：远端对这块 MR 进行 RDMA READ&#x2F;WRITE 时必须提供的 授权令牌，要通过握手显式告诉对端。</li>
</ul>
<blockquote>
<p>RDMA 设备在主机侧的抽象，InfiniBand里叫 HCA；以太网 RoCE 场景是 RNIC。在 Linux verbs 里，应用通过 ibv_open_device() 打开 HCA&#x2F;RNIC 得到上下文（ibv_context*）：</p>
<ul>
<li>暴露 队列对（QP）、完成队列（CQ）、保护域（PD）、注册内存（MR） 等资源；</li>
<li>把应用通过 verbs post 的工作请求（WR）下发到硬件队列，并通过 DMA 直接访问内存；</li>
<li>把执行结果写入 CQE 供应用 ibv_poll_cq() 读取。</li>
</ul>
<p>实现形态：</p>
<ul>
<li>硬件 HCA：如 Mellanox&#x2F;NVIDIA ConnectX 系列；</li>
<li>软件 HCA：如 Soft-RoCE（rxe）</li>
</ul>
</blockquote>
<p>数据通路：</p>
<ol>
<li>发现&#x2F;打开设备：ibv_get_device_list → ibv_open_device；</li>
<li>分配资源：ibv_alloc_pd、ibv_create_cq、ibv_create_qp；</li>
<li>注册内存：ibv_reg_mr（拿到 lkey&#x2F;rkey）；</li>
<li>建链：把 QP 走状态机到 RTS（连接信息可用 RDMA-CM 交换，或 out-of-band）；</li>
<li>收发与完成：<ol>
<li>ibv_post_recv 贴接收缓冲；</li>
<li>发端 ibv_post_send（opcode 可选 IBV_WR_SEND&#x2F;WRITE&#x2F;READ&#x2F;ATOMIC 等）；</li>
<li>循环 ibv_poll_cq 取 WC，检查 status&#x3D;&#x3D;IBV_WC_SUCCESS。</li>
</ol>
</li>
</ol>
<blockquote>
<p>▸ RDMA-CM 与 verbs 的关系<br>RDMA-CM（如 rping、perftest 的 -R）只负责找到RDMA对端；verbs 接口负责具体的数据通路行为。</p>
</blockquote>
<p>伪代码描述：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ctx = ibv_open_device(dev);</span><br><span class="line">pd  = ibv_alloc_pd(ctx);</span><br><span class="line">cq  = ibv_create_cq(ctx, CQ_DEPTH, ...);</span><br><span class="line">qp  = ibv_create_qp(pd, &#123; .send_cq=cq, .recv_cq=cq, .cap=&#123;...&#125;, .qp_type=IBV_QPT_RC &#125;);</span><br><span class="line"></span><br><span class="line">mr_recv = ibv_reg_mr(pd, recv_buf, SZ, IBV_ACCESS_LOCAL_WRITE);</span><br><span class="line">mr_send = ibv_reg_mr(pd, send_buf, SZ, IBV_ACCESS_LOCAL_WRITE|IBV_ACCESS_REMOTE_WRITE|IBV_ACCESS_REMOTE_READ);</span><br><span class="line"></span><br><span class="line"><span class="comment">// （连接信息通过 RDMA-CM 或自定义握手拿到）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收</span></span><br><span class="line">post_recv(recv_buf, lkey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送一个 SEND</span></span><br><span class="line">post_send(send_buf, lkey, IBV_WR_SEND);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 轮询 CQ 直到拿到 WC</span></span><br><span class="line"><span class="keyword">while</span> (!done) &#123;</span><br><span class="line">  n = ibv_poll_cq(cq, &amp;wc);</span><br><span class="line">  <span class="keyword">if</span> (n &gt; <span class="number">0</span> &amp;&amp; wc.status == IBV_WC_SUCCESS) handle(wc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="PingPong-实验"><a href="#PingPong-实验" class="headerlink" title="PingPong 实验"></a>PingPong 实验</h2><p>为了能够深入理解RDMA的机制，笔者尝试动手实现了一个极简版本的PingPong代码，如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdarg&gt;</span>     <span class="comment">// &lt;-- for va_list, va_start, va_end</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>   <span class="comment">// sysconf</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;infiniband/verbs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rdma/rdma_cma.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">size_t</span> kMsgSizeDefault = <span class="number">1024</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span>    kCQDepth        = <span class="number">256</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span>    kQPDepth        = <span class="number">128</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint64_t</span> WRID_RECV = <span class="number">0xBEEF</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint64_t</span> WRID_SEND = <span class="number">0xCAFE</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Options</span> &#123;</span><br><span class="line">  <span class="type">bool</span>        is_server = <span class="literal">false</span>;</span><br><span class="line">  std::string ip        = <span class="string">&quot;10.10.0.1&quot;</span>;</span><br><span class="line">  <span class="type">uint16_t</span>    port      = <span class="number">19999</span>;</span><br><span class="line">  <span class="type">int</span>         iters     = <span class="number">10</span>;</span><br><span class="line">  <span class="type">bool</span>        verbose   = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">size_t</span>      msg_size  = kMsgSizeDefault;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Ctx</span> &#123;</span><br><span class="line">  rdma_event_channel* ec = <span class="literal">nullptr</span>;</span><br><span class="line">  rdma_cm_id*         id = <span class="literal">nullptr</span>;</span><br><span class="line">  ibv_pd*             pd = <span class="literal">nullptr</span>;</span><br><span class="line">  ibv_cq*             cq = <span class="literal">nullptr</span>;</span><br><span class="line">  ibv_qp*             qp = <span class="literal">nullptr</span>;</span><br><span class="line">  ibv_mr*             mr_send = <span class="literal">nullptr</span>;</span><br><span class="line">  ibv_mr*             mr_recv = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">char</span>*               send_buf = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">char</span>*               recv_buf = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">perror</span>(msg);</span><br><span class="line">  std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">diex</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg, <span class="type">int</span> err)</span> </span>&#123;</span><br><span class="line">  std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;%s: %s (%d)\n&quot;</span>, msg, <span class="built_in">strerror</span>(err), err);</span><br><span class="line">  std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">vlog</span><span class="params">(<span class="type">bool</span> on, <span class="type">const</span> <span class="type">char</span>* fmt, ...)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!on) <span class="keyword">return</span>;</span><br><span class="line">  va_list ap;</span><br><span class="line">  <span class="built_in">va_start</span>(ap, fmt);</span><br><span class="line">  std::<span class="built_in">vfprintf</span>(stdout, fmt, ap);</span><br><span class="line">  std::<span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stdout);</span><br><span class="line">  <span class="built_in">va_end</span>(ap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">wc_opcode_str</span><span class="params">(<span class="type">int</span> op)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (op) &#123;</span><br><span class="line">    <span class="keyword">case</span> IBV_WC_SEND: <span class="keyword">return</span> <span class="string">&quot;SEND&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> IBV_WC_RECV: <span class="keyword">return</span> <span class="string">&quot;RECV&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> IBV_WC_RDMA_WRITE: <span class="keyword">return</span> <span class="string">&quot;RDMA_WRITE&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> IBV_WC_RDMA_READ:  <span class="keyword">return</span> <span class="string">&quot;RDMA_READ&quot;</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;OTHER&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">post_one_recv</span><span class="params">(Ctx&amp; ctx, <span class="type">size_t</span> msg_size)</span> </span>&#123;</span><br><span class="line">  ibv_sge sge&#123;&#125;;</span><br><span class="line">  sge.addr   = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint64_t</span>&gt;(ctx.recv_buf);</span><br><span class="line">  sge.length = (<span class="type">uint32_t</span>)msg_size;</span><br><span class="line">  sge.lkey   = ctx.mr_recv-&gt;lkey;</span><br><span class="line"></span><br><span class="line">  ibv_recv_wr wr&#123;&#125;;</span><br><span class="line">  wr.wr_id   = WRID_RECV;</span><br><span class="line">  wr.sg_list = &amp;sge;</span><br><span class="line">  wr.num_sge = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  ibv_recv_wr* bad = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">int</span> rc = <span class="built_in">ibv_post_recv</span>(ctx.qp, &amp;wr, &amp;bad);</span><br><span class="line">  <span class="keyword">if</span> (rc) <span class="built_in">diex</span>(<span class="string">&quot;ibv_post_recv&quot;</span>, rc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">post_one_send</span><span class="params">(Ctx&amp; ctx, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  ibv_sge sge&#123;&#125;;</span><br><span class="line">  sge.addr   = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint64_t</span>&gt;(ctx.send_buf);</span><br><span class="line">  sge.length = (<span class="type">uint32_t</span>)len;</span><br><span class="line">  sge.lkey   = ctx.mr_send-&gt;lkey;</span><br><span class="line"></span><br><span class="line">  ibv_send_wr wr&#123;&#125;;</span><br><span class="line">  wr.wr_id      = WRID_SEND;</span><br><span class="line">  wr.sg_list    = &amp;sge;</span><br><span class="line">  wr.num_sge    = <span class="number">1</span>;</span><br><span class="line">  wr.opcode     = IBV_WR_SEND;</span><br><span class="line">  wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"></span><br><span class="line">  ibv_send_wr* bad = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">int</span> rc = <span class="built_in">ibv_post_send</span>(ctx.qp, &amp;wr, &amp;bad);</span><br><span class="line">  <span class="keyword">if</span> (rc) <span class="built_in">diex</span>(<span class="string">&quot;ibv_post_send&quot;</span>, rc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">wait_one_cqe</span><span class="params">(Ctx&amp; ctx, ibv_wc&amp; wc, <span class="type">bool</span> verbose)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="built_in">ibv_poll_cq</span>(ctx.cq, <span class="number">1</span>, &amp;wc);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) <span class="built_in">die</span>(<span class="string">&quot;ibv_poll_cq&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (wc.status != IBV_WC_SUCCESS) &#123;</span><br><span class="line">      std::<span class="built_in">fprintf</span>(stderr,</span><br><span class="line">                   <span class="string">&quot;CQE error: status=%d wr_id=0x%lx opcode=%d(%s)\n&quot;</span>,</span><br><span class="line">                   wc.status, (<span class="type">unsigned</span> <span class="type">long</span>)wc.wr_id, wc.opcode, <span class="built_in">wc_opcode_str</span>(wc.opcode));</span><br><span class="line">      std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">      std::<span class="built_in">printf</span>(<span class="string">&quot;[cq] wr_id=0x%lx opcode=%d(%s)\n&quot;</span>,</span><br><span class="line">                  (<span class="type">unsigned</span> <span class="type">long</span>)wc.wr_id, wc.opcode, <span class="built_in">wc_opcode_str</span>(wc.opcode));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">usage</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* prog)</span> </span>&#123;</span><br><span class="line">  std::<span class="built_in">fprintf</span>(stderr,</span><br><span class="line">      <span class="string">&quot;Usage: %s (-s|-c) -a &lt;ipv4&gt; [-p &lt;port&gt;] [-n &lt;iters&gt;] [-m &lt;msg_size&gt;] [-v]\n&quot;</span></span><br><span class="line">      <span class="string">&quot;  -s            server mode\n&quot;</span></span><br><span class="line">      <span class="string">&quot;  -c            client mode\n&quot;</span></span><br><span class="line">      <span class="string">&quot;  -a &lt;ipv4&gt;     bind/connect address (IPv4)\n&quot;</span></span><br><span class="line">      <span class="string">&quot;  -p &lt;port&gt;     TCP port for control channel (default 19999)\n&quot;</span></span><br><span class="line">      <span class="string">&quot;  -n &lt;iters&gt;    ping-pong iterations (default 10)\n&quot;</span></span><br><span class="line">      <span class="string">&quot;  -m &lt;bytes&gt;    message buffer size (default 1024)\n&quot;</span></span><br><span class="line">      <span class="string">&quot;  -v            verbose logging\n&quot;</span>,</span><br><span class="line">      prog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  Options opt;</span><br><span class="line">  <span class="type">bool</span> mode_set = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((c = <span class="built_in">getopt</span>(argc, argv, <span class="string">&quot;sca:p:n:m:v&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>: opt.is_server = <span class="literal">true</span>;  mode_set = <span class="literal">true</span>; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>: opt.is_server = <span class="literal">false</span>; mode_set = <span class="literal">true</span>; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>: opt.ip = optarg; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>: opt.port = <span class="built_in">static_cast</span>&lt;<span class="type">uint16_t</span>&gt;(std::<span class="built_in">stoi</span>(optarg)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>: opt.iters = std::<span class="built_in">max</span>(<span class="number">1</span>, std::<span class="built_in">stoi</span>(optarg)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>: opt.msg_size = std::<span class="built_in">max</span>(<span class="number">64</span>, std::<span class="built_in">stoi</span>(optarg)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>: opt.verbose = <span class="literal">true</span>; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>: <span class="built_in">usage</span>(argv[<span class="number">0</span>]); <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!mode_set) &#123; <span class="built_in">usage</span>(argv[<span class="number">0</span>]); <span class="keyword">return</span> <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="literal">nullptr</span>, _IOLBF, <span class="number">0</span>);</span><br><span class="line">  std::<span class="built_in">printf</span>(<span class="string">&quot;[*] mode=%s ip=%s port=%u iters=%d msg=%zu\n&quot;</span>,</span><br><span class="line">              opt.is_server ? <span class="string">&quot;server&quot;</span> : <span class="string">&quot;client&quot;</span>,</span><br><span class="line">              opt.ip.<span class="built_in">c_str</span>(), opt.port, opt.iters, opt.msg_size);</span><br><span class="line"></span><br><span class="line">  Ctx ctx;</span><br><span class="line">  ctx.ec = <span class="built_in">rdma_create_event_channel</span>();</span><br><span class="line">  <span class="keyword">if</span> (!ctx.ec) <span class="built_in">die</span>(<span class="string">&quot;rdma_create_event_channel&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">rdma_create_id</span>(ctx.ec, &amp;ctx.id, <span class="literal">nullptr</span>, RDMA_PS_TCP)) <span class="built_in">die</span>(<span class="string">&quot;rdma_create_id&quot;</span>);</span><br><span class="line"></span><br><span class="line">  sockaddr_in sin&#123;&#125;;</span><br><span class="line">  sin.sin_family = AF_INET;</span><br><span class="line">  sin.sin_port   = <span class="built_in">htons</span>(opt.port);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">inet_pton</span>(AF_INET, opt.ip.<span class="built_in">c_str</span>(), &amp;sin.sin_addr) != <span class="number">1</span>) <span class="built_in">die</span>(<span class="string">&quot;inet_pton&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt.is_server) &#123;</span><br><span class="line">    std::<span class="built_in">puts</span>(<span class="string">&quot;[*] server: bind + listen&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_bind_addr</span>(ctx.id, (sockaddr*)&amp;sin)) <span class="built_in">die</span>(<span class="string">&quot;rdma_bind_addr&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_listen</span>(ctx.id, <span class="number">1</span>)) <span class="built_in">die</span>(<span class="string">&quot;rdma_listen&quot;</span>);</span><br><span class="line">    std::<span class="built_in">puts</span>(<span class="string">&quot;[*] server: waiting CONNECT_REQUEST&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rdma_cm_event* ev = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;ev)) <span class="built_in">die</span>(<span class="string">&quot;rdma_get_cm_event&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;event != RDMA_CM_EVENT_CONNECT_REQUEST) &#123;</span><br><span class="line">      std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;expected CONNECT_REQUEST, got %d\n&quot;</span>, ev-&gt;event);</span><br><span class="line">      std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">vlog</span>(opt.verbose, <span class="string">&quot;[cm] CONNECT_REQUEST arrived&quot;</span>);</span><br><span class="line">    rdma_cm_id* child = ev-&gt;id;</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(ev);</span><br><span class="line">    ctx.id = child;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rdma_cm_event* ev = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_resolve_addr</span>(ctx.id, <span class="literal">nullptr</span>, (sockaddr*)&amp;sin, <span class="number">2000</span>)) <span class="built_in">die</span>(<span class="string">&quot;rdma_resolve_addr&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;ev)) <span class="built_in">die</span>(<span class="string">&quot;rdma_get_cm_event&quot;</span>);</span><br><span class="line">    <span class="built_in">vlog</span>(opt.verbose, <span class="string">&quot;[cm] got event=%d (expected ADDR_RESOLVED=0)&quot;</span>, ev-&gt;event);</span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;event != RDMA_CM_EVENT_ADDR_RESOLVED) <span class="built_in">die</span>(<span class="string">&quot;expected ADDR_RESOLVED&quot;</span>);</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(ev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_resolve_route</span>(ctx.id, <span class="number">2000</span>)) <span class="built_in">die</span>(<span class="string">&quot;rdma_resolve_route&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;ev)) <span class="built_in">die</span>(<span class="string">&quot;rdma_get_cm_event&quot;</span>);</span><br><span class="line">    <span class="built_in">vlog</span>(opt.verbose, <span class="string">&quot;[cm] got event=%d (expected ROUTE_RESOLVED=1)&quot;</span>, ev-&gt;event);</span><br><span class="line">    <span class="keyword">if</span> (ev-&gt;event != RDMA_CM_EVENT_ROUTE_RESOLVED) <span class="built_in">die</span>(<span class="string">&quot;expected ROUTE_RESOLVED&quot;</span>);</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(ev);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源创建</span></span><br><span class="line">  ctx.pd = <span class="built_in">ibv_alloc_pd</span>(ctx.id-&gt;verbs);</span><br><span class="line">  <span class="keyword">if</span> (!ctx.pd) <span class="built_in">die</span>(<span class="string">&quot;ibv_alloc_pd&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ctx.cq = <span class="built_in">ibv_create_cq</span>(ctx.id-&gt;verbs, kCQDepth, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (!ctx.cq) <span class="built_in">die</span>(<span class="string">&quot;ibv_create_cq&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ibv_qp_init_attr qp_init&#123;&#125;;</span><br><span class="line">  qp_init.qp_type = IBV_QPT_RC;</span><br><span class="line">  qp_init.send_cq = ctx.cq;</span><br><span class="line">  qp_init.recv_cq = ctx.cq;</span><br><span class="line">  qp_init.cap.max_send_wr  = kQPDepth;</span><br><span class="line">  qp_init.cap.max_recv_wr  = kQPDepth;</span><br><span class="line">  qp_init.cap.max_send_sge = <span class="number">1</span>;</span><br><span class="line">  qp_init.cap.max_recv_sge = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">rdma_create_qp</span>(ctx.id, ctx.pd, &amp;qp_init)) <span class="built_in">die</span>(<span class="string">&quot;rdma_create_qp&quot;</span>);</span><br><span class="line">  ctx.qp = ctx.id-&gt;qp;</span><br><span class="line">  <span class="built_in">vlog</span>(opt.verbose, <span class="string">&quot;[qp] created qp_num=0x%x&quot;</span>, ctx.qp-&gt;qp_num);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分配并注册内存</span></span><br><span class="line">  <span class="type">long</span> pagesz = <span class="built_in">sysconf</span>(_SC_PAGESIZE);</span><br><span class="line">  <span class="keyword">if</span> (pagesz &lt;= <span class="number">0</span>) pagesz = <span class="number">4096</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">posix_memalign</span>((<span class="type">void</span>**)&amp;ctx.send_buf, (<span class="type">size_t</span>)pagesz, opt.msg_size)) <span class="built_in">die</span>(<span class="string">&quot;posix_memalign send&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">posix_memalign</span>((<span class="type">void</span>**)&amp;ctx.recv_buf, (<span class="type">size_t</span>)pagesz, opt.msg_size)) <span class="built_in">die</span>(<span class="string">&quot;posix_memalign recv&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(ctx.send_buf, <span class="number">0</span>, opt.msg_size);</span><br><span class="line">  <span class="built_in">memset</span>(ctx.recv_buf, <span class="number">0</span>, opt.msg_size);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> access = IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_READ | IBV_ACCESS_REMOTE_WRITE;</span><br><span class="line">  ctx.mr_send = <span class="built_in">ibv_reg_mr</span>(ctx.pd, ctx.send_buf, opt.msg_size, access);</span><br><span class="line">  ctx.mr_recv = <span class="built_in">ibv_reg_mr</span>(ctx.pd, ctx.recv_buf, opt.msg_size, access);</span><br><span class="line">  <span class="keyword">if</span> (!ctx.mr_send || !ctx.mr_recv) <span class="built_in">die</span>(<span class="string">&quot;ibv_reg_mr&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先接收，避免对端首包 RNR</span></span><br><span class="line">  <span class="built_in">post_one_recv</span>(ctx, opt.msg_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 连接</span></span><br><span class="line">  rdma_conn_param conn&#123;&#125;;</span><br><span class="line">  conn.initiator_depth     = <span class="number">1</span>;</span><br><span class="line">  conn.responder_resources = <span class="number">1</span>;</span><br><span class="line">  conn.retry_count         = <span class="number">7</span>;</span><br><span class="line">  conn.rnr_retry_count     = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt.is_server) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_accept</span>(ctx.id, &amp;conn)) <span class="built_in">die</span>(<span class="string">&quot;rdma_accept&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_connect</span>(ctx.id, &amp;conn)) <span class="built_in">die</span>(<span class="string">&quot;rdma_connect&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rdma_cm_event* ev = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;ev)) <span class="built_in">die</span>(<span class="string">&quot;rdma_get_cm_event&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (ev-&gt;event != RDMA_CM_EVENT_ESTABLISHED) <span class="built_in">die</span>(<span class="string">&quot;expected ESTABLISHED&quot;</span>);</span><br><span class="line">  <span class="built_in">rdma_ack_cm_event</span>(ev);</span><br><span class="line">  std::<span class="built_in">puts</span>(<span class="string">&quot;[*] connection ESTABLISHED&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ping-pong 循环</span></span><br><span class="line">  ibv_wc wc;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; opt.iters; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!opt.is_server) &#123;</span><br><span class="line">      <span class="type">size_t</span> len = (<span class="type">size_t</span>)std::<span class="built_in">snprintf</span>(ctx.send_buf, opt.msg_size, <span class="string">&quot;ping %d&quot;</span>, i);</span><br><span class="line">      len = std::<span class="built_in">min</span>(len + <span class="number">1</span>, opt.msg_size);  <span class="comment">// 带 &#x27;\0&#x27; 便于对端直接打印</span></span><br><span class="line">      <span class="built_in">post_one_send</span>(ctx, len);</span><br><span class="line">      <span class="built_in">wait_one_cqe</span>(ctx, wc, opt.verbose); <span class="comment">// SEND 完成</span></span><br><span class="line">      <span class="built_in">wait_one_cqe</span>(ctx, wc, opt.verbose); <span class="comment">// RECV 完成</span></span><br><span class="line">      std::<span class="built_in">printf</span>(<span class="string">&quot;[client] recv: %.*s\n&quot;</span>,</span><br><span class="line">                  (<span class="type">int</span>)<span class="built_in">strnlen</span>(ctx.recv_buf, opt.msg_size), ctx.recv_buf);</span><br><span class="line">      <span class="built_in">post_one_recv</span>(ctx, opt.msg_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">wait_one_cqe</span>(ctx, wc, opt.verbose); <span class="comment">// RECV 完成（收到对端 ping）</span></span><br><span class="line">      std::<span class="built_in">printf</span>(<span class="string">&quot;[server] recv: %.*s\n&quot;</span>,</span><br><span class="line">                  (<span class="type">int</span>)<span class="built_in">strnlen</span>(ctx.recv_buf, opt.msg_size), ctx.recv_buf);</span><br><span class="line">      <span class="type">size_t</span> len = (<span class="type">size_t</span>)std::<span class="built_in">snprintf</span>(ctx.send_buf, opt.msg_size, <span class="string">&quot;pong %d&quot;</span>, i);</span><br><span class="line">      len = std::<span class="built_in">min</span>(len + <span class="number">1</span>, opt.msg_size);</span><br><span class="line">      <span class="built_in">post_one_send</span>(ctx, len);</span><br><span class="line">      <span class="built_in">wait_one_cqe</span>(ctx, wc, opt.verbose); <span class="comment">// SEND 完成</span></span><br><span class="line">      <span class="built_in">post_one_recv</span>(ctx, opt.msg_size);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">rdma_disconnect</span>(ctx.id);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ibv_dereg_mr</span>(ctx.mr_send);</span><br><span class="line">  <span class="built_in">ibv_dereg_mr</span>(ctx.mr_recv);</span><br><span class="line">  <span class="built_in">ibv_destroy_qp</span>(ctx.qp);</span><br><span class="line">  <span class="built_in">ibv_destroy_cq</span>(ctx.cq);</span><br><span class="line">  <span class="built_in">ibv_dealloc_pd</span>(ctx.pd);</span><br><span class="line">  <span class="built_in">rdma_destroy_id</span>(ctx.id);</span><br><span class="line">  <span class="built_in">rdma_destroy_event_channel</span>(ctx.ec);</span><br><span class="line"></span><br><span class="line">  std::<span class="built_in">puts</span>(<span class="string">&quot;done&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><ol>
<li>RDMA-CM 建立</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ctx.ec = rdma_create_event_channel();     <span class="comment">// 事件通道</span></span><br><span class="line">rdma_create_id(ctx.ec, &amp;ctx.id, nullptr, RDMA_PS_TCP);</span><br><span class="line"></span><br><span class="line"><span class="comment">// server：rdma_bind_addr + rdma_listen → 等 CONNECT_REQUEST</span></span><br><span class="line"><span class="comment">// client：rdma_resolve_addr → ADDR_RESOLVED</span></span><br><span class="line"><span class="comment">//         rdma_resolve_route → ROUTE_RESOLVED</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>RDMA-CM 目的是寻址与建链，数据面仍由 verbs 执行。在 RoCEv2 上，CM 实际走 UDP&#x2F;4791 进行寻址；本 demo 额外使用一个 <strong>TCP 端口（默认 19999）</strong>作为参数交换的“控制通道”。</p>
<ol start="2">
<li>资源对象（PD &#x2F; CQ &#x2F; QP）初始化</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ctx.pd = ibv_alloc_pd(ctx.id-&gt;verbs);</span><br><span class="line">ctx.cq = ibv_create_cq(ctx.id-&gt;verbs, kCQDepth, nullptr, nullptr, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">ibv_qp_init_attr qp_init&#123;&#125;;</span><br><span class="line">qp_init.qp_type = IBV_QPT_RC;</span><br><span class="line">qp_init.send_cq = ctx.cq;</span><br><span class="line">qp_init.recv_cq = ctx.cq;</span><br><span class="line">qp_init.cap = &#123; .max_send_wr=kQPDepth, .max_recv_wr=kQPDepth, .max_send_sge=<span class="number">1</span>, .max_recv_sge=<span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">rdma_create_qp(ctx.id, ctx.pd, &amp;qp_init); <span class="comment">// 后续 connect/accept 会自动把 QP 推到 RTS</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>RC（Reliable Connection） 模式下 QP 的状态机为 RESET→INIT→RTR→RTS。简单的，用 rdma_create_qp + rdma_connect&#x2F;accept 让 CM 自动改 QP，避免手写 ibv_modify_qp。</p>
<ol start="3">
<li>先RECV</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post_one_recv(ctx, msg_size);  <span class="comment">// 进入循环前预投一条 RECV</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>RNR（Receiver Not Ready）：对端发 SEND 而本端 RQ 没有可用 WQE 时，会返回 RNR NAK 并触发重试。先 RECV 是 RC 的标准做法。</p>
<ol start="4">
<li>建立链接</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server) rdma_accept(ctx.id, &amp;conn); <span class="keyword">else</span> rdma_connect(ctx.id, &amp;conn);</span><br><span class="line">rdma_get_cm_event(...ESTABLISHED);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>客户端循环体：构造 “ping i” → post_one_send() → 等 SEND 完成 → 再等 RECV 完成（收到服务器 “pong i”）；</li>
<li>服务端：先等 RECV 完成（收到 “ping i”）→ 构造 “pong i” → SEND 完成 → 补一条 RECV 进入下一轮。</li>
</ul>
<ol start="5">
<li>发送数据</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> len = (<span class="type">size_t</span>)</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">snprintf</span>(ctx.send_buf, msg_size, <span class="string">&quot;ping %d&quot;</span>, i);</span><br><span class="line">len = <span class="built_in">std</span>::min(len + <span class="number">1</span>, msg_size);  <span class="comment">// &#x27;\0&#x27;，便于打印</span></span><br><span class="line">post_one_send(ctx, len);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>CQ 轮询</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wait_one_cqe(ctx, wc, verbose);   <span class="comment">// 轮询直到拿到 1 条 CQE</span></span><br><span class="line"><span class="keyword">if</span> (wc.status != IBV_WC_SUCCESS) &#123; ...<span class="built_in">exit</span>... &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里保留了每条 SEND 必带 SIGNALED（每个发送有 CQE），为了便于观察。性能测试时可改成每 N 条 signal 一次。</p>
<ol start="7">
<li>优雅断开</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rdma_disconnect(ctx.id);</span><br><span class="line"></span><br><span class="line">ibv_dereg_mr(ctx.mr_send);</span><br><span class="line">ibv_dereg_mr(ctx.mr_recv);</span><br><span class="line">ibv_destroy_qp(ctx.qp);</span><br><span class="line">ibv_destroy_cq(ctx.cq);</span><br><span class="line">ibv_dealloc_pd(ctx.pd);</span><br><span class="line">rdma_destroy_id(ctx.id);</span><br><span class="line">rdma_destroy_event_channel(ctx.ec);</span><br></pre></td></tr></table></figure>

<p>这里的关闭顺序很关键：断开链接 → 释放 MR&#x2F;QP&#x2F;CQ&#x2F;PD 资源；</p>
<h3 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h3><ol>
<li>编译</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -O3 -Wall rdma_pingpong.cc -o rdma_pingpong -lrdmacm -libverbs</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行</li>
</ol>
<p>服务端（在 10.10.0.1 侧）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./rdma_pingpong -s -a 10.10.0.1 -v</span><br></pre></td></tr></table></figure>

<p>客户端（另一侧连 10.10.0.1）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./rdma_pingpong -c -a 10.10.0.1 -v</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>输出</li>
</ol>
<p>客户端输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./rdma_pingpong -c -a 10.10.0.1 -v</span><br><span class="line"></span><br><span class="line">[*] mode=client ip=10.10.0.1 port=19999 iters=10 msg=1024</span><br><span class="line">[cm] got event=0 (expected ADDR_RESOLVED=0)</span><br><span class="line">[cm] got event=2 (expected ROUTE_RESOLVED=1)</span><br><span class="line">[qp] created qp_num=0x2d</span><br><span class="line">[*] connection ESTABLISHED</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 0</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 1</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 2</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 3</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 4</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 5</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 6</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 7</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 8</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[client] recv: pong 9</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>服务端输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./rdma_pingpong -s -a 10.10.0.1 -v</span><br><span class="line"></span><br><span class="line">[*] mode=server ip=10.10.0.1 port=19999 iters=10 msg=1024</span><br><span class="line">[*] server: <span class="built_in">bind</span> + listen</span><br><span class="line">[*] server: waiting CONNECT_REQUEST</span><br><span class="line">[cm] CONNECT_REQUEST arrived</span><br><span class="line">[qp] created qp_num=0x2e</span><br><span class="line">[*] connection ESTABLISHED</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 0</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 1</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 2</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 3</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 4</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 5</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 6</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 7</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 8</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line">[cq] wr_id=0xbeef opcode=128(RECV)</span><br><span class="line">[server] recv: ping 9</span><br><span class="line">[cq] wr_id=0xcafe opcode=0(SEND)</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="实验结论"><a href="#实验结论" class="headerlink" title="实验结论"></a>实验结论</h3><ul>
<li>event&#x3D;0 是 ADDR_RESOLVED，event&#x3D;2 是 ROUTE_RESOLVED；</li>
<li>opcode&#x3D;0(SEND) 表示本端发送完成 CQE，opcode&#x3D;128(RECV) 表示本端收到对端消息的 CQE；</li>
<li>客户端先 SEND 后 RECV，服务端先 RECV 后 SEND，是合理的 ping→pong 循环时序。</li>
</ul>
<p>以客户端前 3 轮为例：</p>
<ol>
<li>SEND 完成（opcode&#x3D;0, wr_id&#x3D;0xCAFE），说明本地 SQ 中的 SEND WQE 已成功下发并确认，但不代表对端已经处理，只代表本端发送侧完成；</li>
<li>RECV 完成（opcode&#x3D;128, wr_id&#x3D;0xBEEF），说明对端的 “pong i” 已到达并被 RQ 中的 RECV WQE 接住，本端从 CQ 中取到这条完成。</li>
<li>“[client] recv: pong i” 被打印，说明读取 recv_buf，并立刻 post_one_recv()，让下一轮对端的 SEND 不会 RNR。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次 demo 用 RDMA-CM 简化了建链，用 SEND&#x2F;RECV 实现了最简单的的 ping-pong实验，并且给出了 RDMA 相关内容的关键概念对齐。实验结果日志的每一行都对应一个机制节点：CM 事件（0&#x2F;2&#x2F;ESTABLISHED）→ QP 创建 → 首个 RECV 预投 → 循环中 客户端先 SEND 后 RECV、服务端先 RECV 后 SEND → 每次 RECV 完成后立刻补位。可以作为针对 RDMA 入门的极简了解。</p>
<p>下次预告：</p>
<ul>
<li>通过初始 SEND 交换“远端 addr + rkey + len”；</li>
<li>构造 IBV_WR_RDMA_READ&#x2F;WRITE 的 wr.wr.rdma.* 字段；</li>
<li>设计 RECV 池与 Doorbell 批量 post，减少 RNR 与 CQ 压力；</li>
<li>尝试把 RDMA 并入 io_uring 事件环。</li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>RDMA-Toy-1 PingPong和概念梳理</p><p><a href="https://devillove084.github.io/2025/09/20/RDMA-2/">https://devillove084.github.io/2025/09/20/RDMA-2/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>devillove084</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2025-09-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-09-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/rdma/">rdma</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=65f6a62f301e18001359b8f1&amp;product=inline-share-buttons&amp;source=platform" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/images/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/images/wechat.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/09/19/RDMA-1/"><span class="level-item">RDMA-Toy-0 环境简单搭建</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comments"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/valine/1.4.16/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread',
            appId: "qoeAcymwpY5SQb4ABehlBKLq-gzGzoHsz",
            appKey: "Ei0kV5tVeRpYCcAnan39Oqpx",
            
            avatar: "mm",
            avatarForce: false,
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            visitor: false,
            highlight: true,
            recordIP: false,
            
            
            
            enableQQ: false,
            requiredFields: [],
        });</script></div></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/ironman.svg" alt="Database builder" height="28"></a><p class="is-size-7"><span>&copy; 2025 devillove084</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Intro in github" href="https://github.com/devillove084"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/katex.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/katex.min.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><script src="https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js"></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>